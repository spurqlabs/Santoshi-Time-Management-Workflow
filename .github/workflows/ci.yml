name: CI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '25'
          cache: maven

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~\\.m2\\repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2-

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run Maven tests
        run: mvn -B test

      - name: Generate Allure report (if available)
        run: |
          npm install -g allure-commandline --silent || true
          if [ -d "allure-results" ]; then
            allure generate ./allure-results -o ./allure-report --clean || echo "Allure generation failed"
          else
            echo "No allure-results directory found"
          fi
        shell: bash

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Upload Allure HTML report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: Create CI verification instructions
        run: |
          cat > CI_VERIFICATION.md <<'EOF'
          # CI Verification Commands and Checklist

          ## Git commands (PowerShell)

          ```powershell
          git checkout -b ci/add-github-actions
          git add .github/workflows/ci.yml README.md
          git commit -m "Add GitHub Actions CI workflow and README CI docs"
          git push -u origin ci/add-github-actions
          ```

          ## GitHub CLI (optional)

          ```powershell
          gh auth login
          gh workflow run ci.yml --ref main
          gh run list --workflow=ci.yml
          gh run view <run-id> --log
          gh run download <run-id> --name allure-report --dir ./artifacts
          gh run download <run-id> --name allure-results --dir ./artifacts
          ```

          ## Quick verification checklist

          - CI status: workflow run completes successfully (Actions tab or `gh run view` shows success).
          - Build & tests: logs show `BUILD SUCCESS` and test summary (e.g., `Tests run: X, Failures: 0`).
          - Artifacts: `allure-results` and `allure-report` are attached to the run and downloadable.
          - Allure report: open `artifacts/allure-report/index.html` locally and confirm tests/screenshots.
          - Reproducibility: local `mvn -B test` and Allure generation match CI results.

          ## Local commands to reproduce

          ```powershell
          mvn -B test
          allure generate target/allure-results -o target/allure-report --clean
          ii .\target\allure-report\index.html
          ```

          EOF

      - name: Upload CI verification file
        uses: actions/upload-artifact@v4
        with:
          name: ci-verification
          path: CI_VERIFICATION.md
